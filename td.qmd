# TP. Thủ Đức

```{r}
library(readxl)
df <- read_xlsx("C:/Users/Admin/Desktop/measles/data/data.xlsx", sheet = "data")

library(janitor)
library(dplyr)
df <- clean_names(df)
head(df)
df <- filter(df, phan_loai_chan_doan != "Loại trừ sởi")
df$ngay_khoi_phat <- as.Date(df$ngay_khoi_phat)
df$qh <- ifelse(df$qh_th == "Quận 2" | df$qh_th=="Quận 9" |df$qh_th=="Thủ Đức","tp tđ",df$qh_th)
df$ngay_nhap_vien_kham <- as.Date(df$ngay_nhap_vien_kham)
df$dates <- as.Date(ifelse(is.na(df$ngay_khoi_phat), df$ngay_nhap_vien_kham,df$ngay_khoi_phat))
```

**Filter data THU DUC**

```{r}
td <- filter(df, qh == "tp tđ")

tdconvert <- group_by(td, dates)

df_td <- summarise(tdconvert, I=n())
```

**Plot data THU DUC**

```{r}
library(ggplot2)
library(lubridate)
ggplot(df_td,aes(x=dates,y=I)) +
  geom_histogram(stat = "identity", binwidth = 1, width=1, fill ="lightpink", color= "black") +
  labs(x="Day", y="Incidence")+
  theme_minimal() +
  theme (axis.text.x = element_text(angle = 90)) +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"),ymd("2024-09-14")))
```

**Filter data in** **the time period with consecutive cases**

```{r}
df_td <- filter(df_td, dates >= "2024-06-24")

# complete data theo day
library(tidyr)
df_td <- complete(df_td, dates = seq(min(dates), max(dates),by="day"))
df_td <- replace_na(df_td,list( I=0))
df_td$dates <- as.Date(df_td$dates)
```

**Set sliding window**

```{r}
t_start <- seq(2, length(df_td$I) - 13)
t_end <- t_start + 13
```

**Estimates R~t~** **THU DUC**

```{r}
library(EpiEstim)
mod_df_td <- estimate_R(
  incid= df_td,
  method= "parametric_si",
  config = make_config(list(mean_si=14.5, std_si= 3.2, t_start = t_start,   t_end = t_end)
    )
)

plot (mod_df_td)
```

**Plot only R and Incidence**

```{r}
rt_td <- mod_df_td$R

# Lấy dữ liệu ra để vẽ Rt
rt_td$dates <- mod_df_td$dates[rt_td$t_end]
rt_td$q1 <-rt_td$`Quantile.0.025(R)`
rt_td$q3 <- rt_td$`Quantile.0.975(R)`
rt_td$rt <- rt_td$`Mean(R)`
```

```{r}
library(patchwork)
p1td <- ggplot(df_td, aes(x= dates, y= I)) +
  geom_histogram(stat = "identity", binwidth = 1, width=1, fill ="lightpink", color= "black") +
  labs(x="Day", y="Incidence")+
  theme_minimal() + scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-06-20"),ymd("2024-09-14")))

p2td <- ggplot(rt_td,aes(x=dates)) +
  geom_ribbon(aes(ymin=q1,ymax=q3),fill="lightpink",alpha=0.7) +
  geom_line(aes(y= rt), color ="hotpink") +
  geom_hline(yintercept=1, linetype = "dashed", color ="black", size = 1) +
  labs(x="Day", y="Rt") +
  theme_minimal() + 
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-06-20"),ymd("2024-09-14"))) +
  scale_y_continuous(limits = c(0,9))+
  annotate("text", x = ymd("2024-08-27"), y = 9, label = "Chiến dịch tiêm MR", size = 5, hjust = 0.2, color = "red" ) +
  annotate("text", x = ymd("2024-09-01"), y = 8, label = "31/08/2024", size = 5, hjust = 0.4, color = "red") +
  annotate("segment", x = ymd("2024-08-31"), xend = ymd("2024-08-31"), y = 8, yend = 4, arrow = arrow(type = "closed", length = unit(0.2, "cm")), color = "hotpink")

p1td/p2td
```
