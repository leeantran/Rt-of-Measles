# Ước tính R~t~ của Sởi năm 2024

```{r}
library(readxl)
library(EpiEstim)
library(ggplot2)
library(dplyr)
library(janitor)
library(tidyr)
library(knitr)
library(lubridate)

df1 <- read_xlsx("C:/Users/Admin/Desktop/measles/data/data.xlsx", sheet = "data")
df1 <- as.data.frame(df1)
```

**Clean data**

```{r}
df1 <- df1 %>% clean_names()

df <- df1 %>% rename(dates = ngay_khoi_phat,
                    ngaysinh = ngay_sinh,
                    ngaynv = ngay_nhap_vien_kham,
                    tiemchung = tinh_trang_tiem_chung,
                    qh = qh_th,
                    gioi = gioi_tinh)

sum(is.na(df$dates))

# Lấy ngày nhập viện thay cho ngày khởi phát của các ca missing
df$dates[is.na(df$dates)] <- df$ngaynv[is.na(df$dates)]
sum(is.na(df$dates))
```

-   Có 173 ca bị missing **Ngày khởi phát** nên sử dụng **Ngày nhập viện** thay thế cho những ca này.

```{r}
df$cd <- ifelse(df$phan_loai_chan_doan == "Loại trừ sởi", NA, df$phan_loai_chan_doan)
df <- df[,c("dates", "ngaysinh", "tiemchung", "cd", "qh")]

# Loại những ca Sởi loại trừ
df <- na.omit(df)

df_convert <- df %>% group_by(dates) %>% 
  summarise(I = n())

df_complete <- df_convert %>%
    complete(dates = seq(min(dates), max(dates), by = "day")) %>%
    replace_na(list(I = 0))

df_complete$dates <- as.Date(df_complete$dates)
```

**Ước tính hệ số lây nhiễm R~t~**

-   Bộ dữ liệu bao gồm những ca Sởi xác định (Sởi lâm sàng + Sởi xét nghiệm dương tính) từ ngày **04/03/2024** đến **14/09/2024**. Sử dụng ***ngày khởi phát*** để ước tính ***R~t~*** .

```{r}
#| warning: true
#| message: true

mod_raw <- estimate_R(
  incid = df_complete, # Dữ liệu từ 04/03/2024 - end
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25
    )
  )
)

df_rt_raw <- mod_raw$R
df_rt_raw$dates <- mod_raw$dates[df_rt_raw$t_end]
df_rt_raw$q1_rt <- df_rt_raw$`Quantile.0.025(R)`
df_rt_raw$q3_rt <- df_rt_raw$`Quantile.0.975(R)`
df_rt_raw$rt <- df_rt_raw$`Mean(R)`
```

```{r}
library(patchwork)

p_hist_raw <- ggplot(df_complete, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-03-04"), ymd("2024-09-14")))

p_raw <- ggplot(df_rt_raw, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "04/03/2024 - 14/09/2024") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-03-04"), ymd("2024-09-14"))) +
  scale_y_continuous(limits = c(0, 45))

p_hist_raw/p_raw
```

-   Khi ước tính ***R~t~*** từ 04/03/2024 thì có thể là quá sớm vì các ca bệnh xuất hiện lẻ tẻ từ 04/03/2024 đến khoảng 23/05/2024. Số ca bệnh bắt đầu xuất hiện **liên tục** từ 23/05/2024 nên sẽ ước tính ***Rt*** từ ngày này. Do đó, ***R~t~*** sẽ được ước tính từ **23/05/2024** đến **10/09/2024**.

```{r}
# Lọc dữ liệu từ 23/05/2024 - end
df_filter <- filter(df_complete, dates >= "2024-05-30")
```

```{r}
#| message: true
#| warning: true

mod_1w <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25
    )
  )
)
# Lấy dữ liệu ra để vẽ Rt
df_rt_1w <- mod_1w$R
df_rt_1w$dates <- mod_1w$dates[df_rt_1w$t_end]
df_rt_1w$q1_rt <- df_rt_1w$`Quantile.0.025(R)`
df_rt_1w$q3_rt <- df_rt_1w$`Quantile.0.975(R)`
df_rt_1w$rt <- df_rt_1w$`Mean(R)`
```
-   Trong lệnh `esimate_R`, chúng ta có thể tùy chọn ***Sliding window (SW)*** khác nhau để thể hiện kết quả ước tính ***R~t~***. ***Sliding window*** là khoảng thời gian chúng ta dùng để xác định ***R~t~***, ví dụ nếu chúng ta chọn ***SW = 7*** thì giá trị ***R~t~*** sẽ được tính bằng trung bình của 7 ngày. Vậy chúng ta nên chọn \***SW** bằng bao nhiêu? Chúng ta vẽ thử 4 trường hợp của ***SW*** lần lượt là: mỗi ngày, mỗi tuần, mỗi 2 tuần và mỗi tháng để lựa chọn.

```{r}
# SW = 1
t_start <- seq(2, nrow(df_filter)-1)
t_end <- t_start + 1

mod_day <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25,
      t_start = t_start,
      t_end = t_end
    )
  )
)

# Lấy dữ liệu ra để vẽ Rt
df_rt_day <- mod_day$R
df_rt_day$dates <- mod_day$dates[df_rt_day$t_end]
df_rt_day$q1_rt <- df_rt_day$`Quantile.0.025(R)`
df_rt_day$q3_rt <- df_rt_day$`Quantile.0.975(R)`
df_rt_day$rt <- df_rt_day$`Mean(R)`
```

```{r}
# SW = 14
t_start <- seq(2, nrow(df_filter)-13)
t_end <- t_start + 13

mod_2w <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25,
      t_start = t_start,
      t_end = t_end
    )
  )
)

# Lấy dữ liệu ra để vẽ Rt
df_rt_2w <- mod_2w$R
df_rt_2w$dates <- mod_2w$dates[df_rt_2w$t_end]
df_rt_2w$q1_rt <- df_rt_2w$`Quantile.0.025(R)`
df_rt_2w$q3_rt <- df_rt_2w$`Quantile.0.975(R)`
df_rt_2w$rt <- df_rt_2w$`Mean(R)`
```

```{r}
# SW = 28
t_start <- seq(2, nrow(df_filter)-27)
t_end <- t_start + 27

mod_month <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25,
      t_start = t_start,
      t_end = t_end
    )
  )
)

# Lấy dữ liệu ra để vẽ Rt
df_rt_month <- mod_month$R
df_rt_month$dates <- mod_month$dates[df_rt_month$t_end]
df_rt_month$q1_rt <- df_rt_month$`Quantile.0.025(R)`
df_rt_month$q3_rt <- df_rt_month$`Quantile.0.975(R)`
df_rt_month$rt <- df_rt_month$`Mean(R)`
```

```{r}
#| fig-height: 8
#| fig-width: 14

library(patchwork)

# Biểu đồ đường cong dịch
p_hist <- ggplot(df_filter, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"), ymd("2024-09-14")))

# Biểu đồ cho 1 tuần
p_1w <- ggplot(df_rt_1w, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "1 Week") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"), ymd("2024-09-14"))) +
  scale_y_continuous(limits = c(0, 8))

# Biểu đồ cho 1 ngày
p_day <- ggplot(df_rt_day, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "1 Day") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"), ymd("2024-09-14"))) +
  scale_y_continuous(limits = c(0, 10))

# Biểu đồ cho 2 tuần
p_2w <- ggplot(df_rt_2w, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "2 Week") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"), ymd("2024-09-14"))) +
  scale_y_continuous(limits = c(0, 10))

# Biểu đồ cho 1 tháng
p_month <- ggplot(df_rt_month, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "1 Month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"), ymd("2024-09-14"))) +
  scale_y_continuous(limits = c(0, 5))

(p_hist + p_hist)/(p_day + p_1w)
```

```{r}
#| fig-height: 8
#| fig-width: 14
library(patchwork)

(p_hist + p_hist)/(p_2w + p_month)
```

-   ***R~t~*** cao khi số ca bắt đầu tăng đột ngột và liên tục, càng về sau ***R~t~*** giảm xuống gần bằng **1** nhưng không duy trì được giá trị **R~t~ \< 1** chứng tỏ dịch vẫn đang diễn ra. Với **SW = 1 tuần** thì **R~t~ \~ 14**; **Sliding window = 2 tuần** thì **R~t~ \~ 19**; các khoảng **Sliding window** khác có giá trị **R~t~** thấp hơn rất nhiều vào ngày ước tính đầu tiên. Theo lý thuyết, ***R~t~*** sẽ cao khoảng thời gian đầu do dịch mới bùng phát mà 2 tuần trước đó không có ca bệnh xuất hiện liên tục. Do đó, chúng ta chọn giữa ***SW = 7*** hoặc ***SW = 14*** để ước tính.

-   Tuy nhiên, kết quả cho thấy ***R~t~*** được ước tính với ***SW là 2 tuần*** cho kết quả ổn định hơn, giá trị không lên xuống thất thường nên phù hợp để xem xét và đánh giá diễn tích của dịch. Ngoài ra, khoảng tin cậy của ***R~t~*** trong thời đầu là quá lớn (khi ***SW là 1 tuần***) nên sẽ không đảm bảo tính tin cậy của ***R~t~***.

**Ước tính Rt với sliding window là 2 tuần**

```{r}
#| fig-height: 8
#| fig-width: 14

library(patchwork)

p_hist <- ggplot(df_filter, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"), ymd("2024-09-14")))

p_2w <- ggplot(df_rt_2w, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "13/06 - 14/09") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8)) + 
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-30"), ymd("2024-09-14"))) +
  scale_y_continuous(breaks = seq(0,10,by = 2))

p_hist/p_2w
```

-   *Dữ liệu để ước tính **R~t~** là từ 30/05/2024, nên R~t~ sẽ được tính từ ngày 13/06/2024 (Do Serial interval có trung bình là 14 ngày). **R~t~ \~ 7.07*** vào 13/06/2024, sau đó giảm dần khi dịch bắt đầu xảy ra (số ca mới xuất hiện liên tục) và cho đến ngày 14/09/2024 (khoảng tuần 36) thì ***R~t~ vẫn lớn hơn 1*** chứng tỏ dịch vẫn đang diễn ra và số ca bệnh có thể vẫn tiếp tục tăng.

- Để quan sát được rõ hơn diễn tiến dịch trong 2 tháng gần nhất, hình sẽ được phóng to từ ngày 12/07 đến 14/09:

```{r}
#| fig-height: 7
#| fig-width: 14

library(patchwork)
library(scales)

x_text_date = "2024-08-31"
y_text = 8

# Biểu đồ đường cong dịch
p_hist <- ggplot(df_filter, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8)) + 
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-07-12"), ymd("2024-09-14")))

# Biểu đồ Rt
p_rt <- ggplot(df_rt_2w, aes(x = dates)) +
    geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.4) + 
    geom_line(aes(y = rt), color = "darkorange", size = 1.3) +  
    geom_hline(yintercept = 1, linetype = "dashed", color = "black", size = 0.8) + 
  geom_segment(aes(x = as.Date("2024-08-31"), xend = as.Date("2024-08-31"), y = 4, yend = 0),
                 linetype = "solid", color = "black", size = 1.2) +  
    labs(x = "Day", y = "Rt") +
    theme_minimal(base_size = 16) +  
    theme(
        axis.text.x = element_text(angle = 60, hjust = 1, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        plot.background = element_rect(fill = "#FAFAFA", color = NA),
        panel.grid.major.x = element_line(color = "gray80", size = 0.5),
        panel.grid.major.y = element_line(color = "gray80", size = 0.5)
    ) +
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", 
                 limits = c(ymd("2024-07-12"), ymd("2024-09-14")), expand = c(0.01, 0.01)) +
    scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, by = 1)) +
    annotate("text", x = ymd("2024-09-01"), y = 3.5, label = "Chiến dịch tiêm chủng", 
             size = 5, hjust = -0.1, color = "black", fontface = "bold") +
    annotate("text", x = ymd("2024-07-30"), y = 3.5, label = "Chưa có can thiệp", 
             size = 5, hjust = -0.1, color = "black", fontface = "bold") +
    annotate("rect", xmin = ymd("2024-08-31"), xmax = ymd("2024-09-14"), ymin = 3, ymax = 4,
             alpha = 0.15, fill = "lightblue", color = "black") +
    annotate("rect", xmin = ymd("2024-07-12"), xmax = ymd("2024-08-31"), ymin = 3, ymax = 4, 
             alpha = 0.15, fill = "lightblue", color = "black")


p_hist / p_rt
```
- Từ 18/07/2024, ***R~t~*** có xu hướng tăng trở lại và dao động từ **1.08 - 1.98**. Giá trị ***R~t~*** bắt đầu đi ngang từ 24/08/2024 và đến 31/08/2024 là **1.26**.

- Từ ngày 31/08/2024, bắt đầu triển khai "Chiến dịch tiêm chủng" trên cộng đồng và trên đối tượng trẻ từ 1 - 10 tuổi. Có thể thấy được sau khi thực hiện chiến dịch được 1 tuần thì số R~t~ bắt đầu đi ngang trong tuần đầu tiên và giảm trong tuần thứ 2 sau chiến dịch (***R~t~ = 1.06*** ngày 11/09 và đến 14/09 thì ***R~t~ = 1.04*** chứng tỏ dịch vẫn đang diễn ra và số ca bệnh có thể vẫn tiếp tục tăng.

- Tuy nhiên, thời gian tạo miễn dịch từ vắc xin là 2 - 4 tuần, do đó chúng ta cần dữ liệu từ 14/09 trở về sau để đánh giá thêm có phải là hiệu quả của chiến dịch hay không? Nhưng đến thời điểm hiện tại, ngoài thực hiện chính sách can thiệp từ ngày 31/08/2024 thì trước đó Thành phố cũng chủ động truyền thông về dự phòng bệnh Sởi, do đó có thể R~t~ giảm trong giai đoạn từ 06/09/2024 có thể do kết hợp 2 biện pháp này.

```{r}
library(knitr)
kable(df_rt_2w[,c("dates", "rt")])
```
