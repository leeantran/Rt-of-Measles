# Ước tính R~t~ của Sởi năm 2024

## Serial interval

-   Dữ liệu hiện có không thể tính được ***Serial interval*** theo định nghĩa. Do đó, sẽ dựa vào y văn và chọn ***Serial interval*** có trung bình là **14.5 ngày** và độ lệch chuẩn là **3.25 ngày** [@worden2020e].

## Ước tính R~t~

```{r}
library(readxl)
library(EpiEstim)
library(ggplot2)
library(dplyr)
library(janitor)
library(tidyr)
library(knitr)
library(lubridate)

df <- read_xlsx("C:/Users/Admin/Desktop/modelling/data/20240826_case_noti.xlsx", sheet = "solieu_HCM-DCD-ODICH")
df <- as.data.frame(df)
head(df)
```

**Clean data**

```{r}
#| warning: false
#| message: false

df <- df %>% clean_names()
df <- df %>% rename(dates = ngay_khoi_phat_1, I = ketqua)
df <- df[,c("dates", "I")]
df <- na.omit(df)

df_complete <- df %>%
    complete(dates = seq(min(dates), max(dates), by = "day")) %>%
    replace_na(list(I = 0))

df_complete$dates <- as.Date(df_complete$dates)
```

**Ước tính hệ số lây nhiễm R~t~**

-   Bộ dữ liệu bao gồm những ca Sởi xác định (Sởi lâm sàng + Sởi xét nghiệm dương tính) từ ngày **04/03/2024** đến **23/08/2024**. Sử dụng ***ngày khởi phát*** để ước tính ***R~t~*** .

```{r}
#| warning: true
#| message: true

mod_raw <- estimate_R(
  incid = df_complete, # Dữ liệu từ 04/03/2024 đến 23/08/2024 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25
    )
  )
)

df_rt_raw <- mod_raw$R
df_rt_raw$dates <- mod_raw$dates[df_rt_raw$t_end]
df_rt_raw$q1_rt <- df_rt_raw$`Quantile.0.025(R)`
df_rt_raw$q3_rt <- df_rt_raw$`Quantile.0.975(R)`
df_rt_raw$rt <- df_rt_raw$`Mean(R)`
```

```{r}
library(patchwork)

p_hist_raw <- ggplot(df_complete, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-03-04"), ymd("2024-08-23")))

p_raw <- ggplot(df_rt_raw, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "04/03/2024 - 18/08/2024") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-03-04"), ymd("2024-08-23"))) +
  scale_y_continuous(limits = c(0, 20))

p_hist_raw/p_raw
```

-   Khi ước tính ***R~t~*** từ 04/03/2024 thì có thể là quá sớm vì các ca bệnh xuất hiện lẻ tẻ từ 04/03/2024 đến khoảng 20/5/2024. Số ca bệnh bắt đầu xuất hiện liên tục từ 23/05/2024 nên sẽ ước tính ***Rt*** từ ngày này. Do đó, ***R~t~*** sẽ được ước tính từ **23/05/2024** đến **23/08/2024**.

```{r}
# Lọc dữ liệu từ 23/05/2024 - end
df_filter <- filter(df_complete, dates >= "2024-05-23")
```

```{r}
mod_1w <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25
    )
  )
)
# Lấy dữ liệu ra để vẽ Rt
df_rt_1w <- mod_1w$R
df_rt_1w$dates <- mod_1w$dates[df_rt_1w$t_end]
df_rt_1w$q1_rt <- df_rt_1w$`Quantile.0.025(R)`
df_rt_1w$q3_rt <- df_rt_1w$`Quantile.0.975(R)`
df_rt_1w$rt <- df_rt_1w$`Mean(R)`
```

```{r}
#| fig-height: 7
#| fig-width: 14

library(patchwork)

# Biểu đồ đường cong dịch
p_hist <- ggplot(df_filter, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() +
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-23"), ymd("2024-08-23")))

# Biểu đồ cho 1 tuần
p_1w <- ggplot(df_rt_1w, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "23/05/2024 - 23/08/2024") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-23"), ymd("2024-08-23"))) +
  scale_y_continuous(limits = c(0, 20))
```

```{r}
#| fig-height: 7
#| fig-width: 14

library(patchwork)

(p_hist_raw + p_hist) / (p_raw + p_1w)
```

-   Trong lệnh `esimate_R`, chúng ta có thể tùy chọn ***Sliding window (SW)*** khác nhau để thể hiện kết quả ước tính ***R~t~***. ***Sliding window*** là khoảng thời gian chúng ta dùng để xác định ***R~t~***, ví dụ nếu chúng ta chọn ***SW = 7*** thì giá trị ***R~t~*** sẽ được tính bằng trung bình của 7 ngày. Vậy chúng ta nên chọn \***SW** bằng bao nhiêu? Chúng ta vẽ thử 4 trường hợp của ***SW*** lần lượt là: mỗi ngày, mỗi tuần, mỗi 2 tuần và mỗi tháng để lựa chọn.

```{r}

t_start <- seq(2, nrow(df_filter)-1)
t_end <- t_start + 1

mod_day <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25,
      t_start = t_start,
      t_end = t_end
    )
  )
)

# Lấy dữ liệu ra để vẽ Rt
df_rt_day <- mod_day$R
df_rt_day$dates <- mod_day$dates[df_rt_day$t_end]
df_rt_day$q1_rt <- df_rt_day$`Quantile.0.025(R)`
df_rt_day$q3_rt <- df_rt_day$`Quantile.0.975(R)`
df_rt_day$rt <- df_rt_day$`Mean(R)`
```

```{r}
t_start <- seq(2, nrow(df_filter)-13)
t_end <- t_start + 13

mod_2w <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25,
      t_start = t_start,
      t_end = t_end
    )
  )
)

# Lấy dữ liệu ra để vẽ Rt
df_rt_2w <- mod_2w$R
df_rt_2w$dates <- mod_2w$dates[df_rt_2w$t_end]
df_rt_2w$q1_rt <- df_rt_2w$`Quantile.0.025(R)`
df_rt_2w$q3_rt <- df_rt_2w$`Quantile.0.975(R)`
df_rt_2w$rt <- df_rt_2w$`Mean(R)`
```

```{r}
t_start <- seq(2, nrow(df_filter)-27)
t_end <- t_start + 27

mod_month <- estimate_R(
  incid = df_filter, 
  method = "parametric_si", 
  config = make_config(
    list(
      mean_si = 14.5, 
      std_si = 3.25,
      t_start = t_start,
      t_end = t_end
    )
  )
)

# Lấy dữ liệu ra để vẽ Rt
df_rt_month <- mod_month$R
df_rt_month$dates <- mod_month$dates[df_rt_month$t_end]
df_rt_month$q1_rt <- df_rt_month$`Quantile.0.025(R)`
df_rt_month$q3_rt <- df_rt_month$`Quantile.0.975(R)`
df_rt_month$rt <- df_rt_month$`Mean(R)`
```

```{r}
#| fig-height: 8
#| fig-width: 14

library(patchwork)

# Biểu đồ đường cong dịch
p_hist <- ggplot(df_filter, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() +
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-23"), ymd("2024-08-23")))

# Biểu đồ cho 1 tuần
p_1w <- ggplot(df_rt_1w, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "1 Week") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-23"), ymd("2024-08-23"))) +
  scale_y_continuous(limits = c(0, 20))

# Biểu đồ cho 1 ngày
p_day <- ggplot(df_rt_day, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "1 Day") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-23"), ymd("2024-08-23"))) +
  scale_y_continuous(limits = c(0, 20))

# Biểu đồ cho 2 tuần
p_2w <- ggplot(df_rt_2w, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "2 Week") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-23"), ymd("2024-08-23"))) +
  scale_y_continuous(limits = c(0, 30))

# Biểu đồ cho 1 tháng
p_month <- ggplot(df_rt_month, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "1 Month") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-05-23"), ymd("2024-08-23"))) +
  scale_y_continuous(limits = c(0, 20))

(p_hist + p_hist)/(p_day + p_1w)
```

```{r}
#| fig-height: 8
#| fig-width: 14
library(patchwork)

(p_hist + p_hist)/(p_2w + p_month)
```

-   ***R~t~*** cao khi số ca bắt đầu tăng đột ngột và liên tục, càng về sau ***R~t~*** giảm xuống gần bằng **1** nhưng không duy trì được giá trị **R~t~ \< 1** chứng tỏ dịch vẫn đang diễn ra. Với **SW = 1 tuần** thì **R~t~ \~ 14**; **Sliding window = 2 tuần** thì **R~t~ \~ 19**; các khoảng **Sliding window** khác có giá trị **R~t~** thấp hơn rất nhiều vào ngày ước tính đầu tiên. Theo lý thuyết, ***R~t~*** sẽ cao khoảng thời gian đầu do dịch mới bùng phát mà 2 tuần trước đó không có ca bệnh xuất hiện liên tục. Do đó, chúng ta chọn giữa ***SW = 7*** hoặc ***SW = 14*** để ước tính.

-   Tuy nhiên, kết quả cho thấy ***R~t~*** được ước tính với ***SW là 2 tuần*** cho kết quả ổn định hơn, giá trị không lên xuống thất thường nên phù hợp để xem xét và đánh giá diễn tích của dịch. Ngoài ra, khoảng tin cậy của ***R~t~*** trong thời đầu là quá lớn (khi ***SW là 1 tuần***) nên sẽ không đảm bảo tính tin cậy của ***R~t~***.

**Ước tính Rt với sliding window là 2 tuần**

```{r}
#| fig-height: 8
#| fig-width: 14
library(patchwork)

p_hist <- ggplot(df_filter, aes(x = dates, y = I)) +
    geom_histogram(stat = "identity", binwidth = 1, width = 1, fill = "lightgrey", color = "black") +
    labs(x = "Day", y = "Incidence") +
    theme_minimal() +
    scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-06-08"), ymd("2024-08-23")))

p_2w <- ggplot(df_rt_2w, aes(x = dates)) +
  geom_ribbon(aes(ymin = q1_rt, ymax = q3_rt), fill = "lightcoral", alpha = 0.3) + 
  geom_line(aes(y = rt), color = "darkorange") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black") + 
  labs(x = "Day", y = "Rt", title = "08/06 - 23/08") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 week", limits = c(ymd("2024-06-08"), ymd("2024-08-23"))) +
  scale_y_continuous(breaks = seq(0, 16, by = 4))

p_hist/p_2w
```

-   ***Rt \~ 8.99*** vào 08/06/2024, sau đó giảm dần khi dịch bắt đầu xảy ra (số ca mới xuất hiện liên tục) và cho đến ngày 23/08/2024 (khoảng tuần 34) thì ***R~t~ vẫn lớn hơn 1*** chứng tỏ dịch vẫn đang diễn ra và số ca bệnh có thể vẫn tiếp tục tăng.

```{r}
library(knitr)
kable(df_rt_2w[,c("dates", "rt")])
```
